<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
  <meta charset="UTF-8">
  <title>Детали товара | Vinyl </title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header class="site-header">
  <div class="container header-content">
    <a href="/user/products/catalog" class="logo">Vinyl</a>
    <div class="user-nav" sec:authorize="isAuthenticated()">
      <!-- Бейдж "Администратор" -->
      <span sec:authorize="hasRole('ADMIN')"
            style="background: rgba(255, 255, 255, 0.2); color: white; padding: 5px 10px; border-radius: 4px;">
        Администратор
    </span>

      <!-- Меню для ПОЛЬЗОВАТЕЛЕЙ -->
      <span sec:authorize="hasRole('USER')">
        <a href="/user/products/catalog">Каталог</a>
        <a href="/basket">Корзина</a>
        <a href="/user/profile">Профиль</a>
    </span>

      <!-- Меню для АДМИНОВ (твои реальные разделы) -->
      <span sec:authorize="hasRole('ADMIN')">
        <a href="/admin/products">Товары</a>
        <!-- Если есть заказы:
        <a href="/admin/orders">Заказы</a> -->
        <a href="/admin">Панель</a>
    </span>

      <!-- Выход для всех -->
      <a href="/logout">Выйти</a>
    </div>
  </div>
</header>

<div class="container">



  <!-- Сообщения об успехе/ошибке -->
  <div th:if="${reviewSuccess}" class="alert alert-success alert-dismissible fade show">
    [[${reviewSuccess}]]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${reviewError}" class="alert alert-danger alert-dismissible fade show">
    [[${reviewError}]]
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>



  <!-- Навигация назад -->
  <div class="mb-3">
    <a sec:authorize="hasRole('USER')"
       th:href="@{/user/products/catalog}"
       class="btn btn-secondary btn-sm">
      ← Назад в каталог
    </a>
    <a sec:authorize="hasRole('ADMIN')"
       th:href="@{/admin/products}"
       class="btn btn-secondary btn-sm">
      ← К управлению товарами
    </a>
  </div>

  <!-- Заголовок -->
  <h1 class="product-title" th:text="${product.name}"></h1>

  <!-- Карточка товара -->
  <div class="details-card">
    <div class="detail-row">
      <span class="detail-label">Категория:</span>
      <span class="detail-value" th:text="${product.category?.name} ?: '—'"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Бренд:</span>
      <span class="detail-value" th:text="${product.brand?.name} ?: '—'"></span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Цена:</span>
      <span class="detail-value price" th:text="${#numbers.formatDecimal(product.price, 0, 2)} + ' руб.'"></span>
    </div>
    <div class="detail-row description-row">
      <span class="detail-label">Описание:</span>
      <p class="detail-description" th:text="${product.description} ?: 'Нет описания'"></p>
    </div>
    <div class="detail-row">
      <span class="detail-label">На складе:</span>
      <span th:class="${product.stock > 0} ? 'stock-available' : 'stock-unavailable'"
            class="detail-value stock-info"
            th:text="${product.stock > 0} ? (${product.stock} + ' шт.') : 'Нет в наличии'">
                </span>
    </div>
  </div>

  <!-- Действия для пользователей -->
  <div sec:authorize="hasRole('USER')" class="card text-center">
    <div class="flex gap-2 justify-center">
      <a th:href="@{/basket/add/{id}(id=${product.id})}"
         th:if="${product.stock > 0}"
         class="btn btn-success btn-lg">
        Добавить в корзину
      </a>
      <button th:unless="${product.stock > 0}"
              class="btn btn-secondary btn-lg"
              disabled>
        Нет в наличии
      </button>
    </div>
  </div>

  <!-- Действия для администраторов -->
  <div sec:authorize="hasRole('ADMIN')" class="card">
    <div class="flex gap-2">
      <a th:href="@{/admin/products/update/{id}(id=${product.id})}"
         class="btn btn-warning">
        Редактировать
      </a>
      <form th:action="@{/admin/products/delete/{id}(id=${product.id})}"
            method="post"
            class="delete-form"
            onsubmit="return confirm('Удалить товар? Это действие нельзя отменить.');">
        <button type="submit" class="btn btn-danger">
          Удалить
        </button>
      </form>
    </div>
  </div>

  <!-- ============= БЛОК ОТЗЫВОВ (НОВОЕ) ============= -->
  <div class="mt-5">
    <h3>Отзывы покупателей</h3>

    <!-- Форма добавления отзыва -->
    <div sec:authorize="isAuthenticated()" class="card p-4 mb-4">
      <h4>Оставить отзыв</h4>
      <form th:action="@{/reviews/add}" method="post">
        <input type="hidden" name="productId" th:value="${product.id}">

        <div class="mb-3">
          <label class="form-label">Ваша оценка:</label>
          <select name="rating" class="form-select" style="max-width: 200px;" required>
            <option value="" disabled selected>Выберите оценку</option>
            <option value="5">5 ★ Отлично</option>
            <option value="4">4 ★ Хорошо</option>
            <option value="3">3 ★ Удовлетворительно</option>
            <option value="2">2 ★ Плохо</option>
            <option value="1">1 ★ Ужасно</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Текст отзыва:</label>
          <textarea name="text" class="form-control" rows="4"
                    placeholder="Напишите ваш отзыв здесь..."
                    minlength="10" maxlength="2000" required></textarea>
          <small class="text-muted">От 10 до 2000 символов</small>
        </div>

        <button type="submit" class="btn btn-primary">Отправить отзыв</button>
      </form>
    </div>

    <!-- Сообщение для неавторизованных -->
    <div sec:authorize="!isAuthenticated()" class="alert alert-info">
      <a href="/login">Войдите</a>, чтобы оставить отзыв
    </div>

    <!-- Список отзывов -->
    <div th:if="${product.reviews != null && !product.reviews.isEmpty()}">
      <div class="review-list">
        <div th:each="review : ${product.reviews}" class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <h5 class="card-title">
                <strong th:text="${review.user.username}"></strong>
                <span class="text-warning">
                  <span th:each="i : ${#numbers.sequence(1, 5)}">
                    <span th:if="${i <= review.rating}">★</span>
                    <span th:unless="${i <= review.rating}">☆</span>
                  </span>
                </span>
              </h5>
              <small class="text-muted"
                     th:text="${#temporals.format(review.createdAt, 'dd.MM.yyyy HH:mm')}"></small>
            </div>
            <p class="card-text mt-2" th:text="${review.text}"></p>

            <!-- Кнопка удаления (только для автора или админа) -->
            <div sec:authorize="isAuthenticated()">
              <form th:action="@{/reviews/delete/{id}(id=${review.id})}"
                    method="post"
                    th:if="${review.user.id == #authentication.principal.id or hasRole('ROLE_ADMIN')}"
                    style="display: inline;">
                <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Удалить этот отзыв?');">
                  Удалить
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Сообщение, если отзывов нет -->
    <div th:unless="${product.reviews != null && !product.reviews.isEmpty()}" class="alert alert-light">
      Пока нет отзывов. Будьте первым!
    </div>
  </div>
  <!-- ============= КОНЕЦ БЛОКА ОТЗЫВОВ ============= -->

</div> <!-- закрывающий container -->
</body>
</html>