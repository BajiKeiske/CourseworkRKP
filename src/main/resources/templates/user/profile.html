<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Мой профиль | Vinyl </title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<header class="site-header">
    <div class="container header-content">
        <a href="/user/products/catalog" class="logo">Vinyl Store</a>
        <div class="user-nav">
            <a href="/user/products/catalog">Каталог</a>
            <a href="/basket">Корзина</a>
            <a href="/user/profile">Профиль</a>
            <a href="/logout">Выйти</a>
        </div>
    </div>
</header>

<div class="container">
    <h1>Мой профиль</h1>

    <!-- Аватарка с формой загрузки -->
    <div class="details-card">
        <div class="text-center mb-4">
            <!-- Текущая аватарка -->
            <img th:src="${user.avatarUrl != null} ? ${user.avatarUrl} : '/images/default-avatar.png'"
                 alt="Аватар"
                 style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #bd4252; margin-bottom: 15px;">

            <!-- Форма загрузки новой аватарки -->
            <form th:action="@{/user/upload-avatar}" method="post" enctype="multipart/form-data" class="mt-3">
                <div class="mb-2">
                    <label for="avatarFile" class="form-label" style="display: block; margin-bottom: 5px;">
                        Изменить фото профиля
                    </label>
                    <input type="file" name="avatarFile" id="avatarFile"
                           class="form-control" style="width: auto; display: inline-block;"
                           accept="image/*">
                </div>
                <button type="submit" class="btn btn-secondary btn-sm">
                    Загрузить
                </button>
                <div class="form-text" style="font-size: 0.9em; margin-top: 5px;">
                    Поддерживаются JPG, PNG. Макс. 5MB
                </div>
            </form>
        </div>

        <div class="detail-row">
            <span class="detail-label">Логин:</span>
            <span class="detail-value" th:text="${user.username}"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Email:</span>
            <span class="detail-value" th:text="${user.email}"></span>
        </div>
        <div class="detail-row">
            <span class="detail-label">Роль:</span>
            <span class="detail-value" th:text="${user.role}"></span>
        </div>
    </div>

    <!-- ... остальная часть профиля (статистика, кнопки) без изменений -->

    <!-- Статистика -->
    <div class="details-card">
        <h3 style="color: #bd4252; margin-bottom: 25px;">Статистика</h3>

        <div class="detail-row">
            <span class="detail-label">Всего заказов:</span>
            <span class="detail-value">
                    <span th:if="${user.orders != null}" th:text="${user.orders.size()}">0</span>
                    <span th:if="${user.orders == null}">0</span>
                </span>
        </div>

        <div class="detail-row">
            <span class="detail-label">Активных заказов:</span>
            <span class="detail-value">
                    <span th:if="${user.orders != null}"
                          th:text="${#lists.size(user.orders.?[status == 'PENDING'])}">0</span>
                    <span th:if="${user.orders == null}">0</span>
                </span>
        </div>

        <div class="detail-row">
            <span class="detail-label">Общая сумма покупок:</span>
            <span class="detail-value price">
                    <span th:if="${user.orders != null and !user.orders.empty}"
                          th:text="${#numbers.formatDecimal(
                              user.orders.?[totalAmount != null]
                                  .stream()
                                  .mapToDouble(order -> order.totalAmount.doubleValue())
                                  .sum()
                          , 0, 2)} + ' руб.'">0 руб.</span>
                    <span th:if="${user.orders == null}">0 руб.</span>
                </span>
        </div>
    </div>

    <!-- Быстрые ссылки -->
    <div class="card text-center">
        <div class="flex gap-2 justify-between">
            <a href="/basket" class="btn btn-primary">Моя корзина</a>
            <a href="/user/orders" class="btn btn-info">Мои заказы</a>
            <a href="/user/products/catalog" class="btn btn-success">Продолжить покупки</a>
        </div>
    </div>
</div>
</body>
</html>